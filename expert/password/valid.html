<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="/expert/resources/css/common.css">
    <link rel="stylesheet" href="/expert/resources/css/password.css">

                    <button type="submit" class="btn btn-primary" id="submitBtn" disabled>
                        🔐 パスワードを変更する
                    </button>

                    <div class="security-notice">
                        <h4>🛡️ セキュリティについて</h4>
                        <p>
                            • 変更後は新しいパスワードで再ログインが必要です<br>
                            • すべてのデバイスからログアウトされます<br>
                            • 変更通知メールをお送りします
                        </p>
                    </div>

                    <div class="help-links">
                        <p>メールが届かない場合やお困りの際は</p>
                        <a href="../contact.html">お問い合わせ</a>
                        <a href="tel:03-1234-5678">電話サポート</a>
                        <a href="mailto:support@knowledgecast.com">メールサポート</a>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        let timeRemaining = 300; // 5分
        let timerInterval;

        // タイマー開始
        function startTimer() {
            timerInterval = setInterval(() => {
                timeRemaining--;
                const minutes = Math.floor(timeRemaining / 60);
                const seconds = timeRemaining % 60;
                document.getElementById('codeTimer').textContent = 
                    `${minutes}:${seconds.toString().padStart(2, '0')}`;

                if (timeRemaining <= 0) {
                    clearInterval(timerInterval);
                    document.getElementById('codeTimer').textContent = '期限切れ';
                    document.getElementById('resendLink').classList.remove('disabled');
                }
            }, 1000);
        }

        // パスワード要件チェック
        function checkPasswordRequirements(password) {
            const requirements = {
                length: password.length >= 8,
                upper: /[A-Z]/.test(password),
                lower: /[a-z]/.test(password),
                number: /\d/.test(password),
                special: /[!@#$%^&*]/.test(password)
            };

            // 各要件の表示更新
            Object.keys(requirements).forEach(req => {
                const element = document.getElementById(req + 'Req');
                const icon = element.querySelector('.requirement-icon');
                if (requirements[req]) {
                    element.classList.add('valid');
                    icon.textContent = '✓';
                } else {
                    element.classList.remove('valid');
                    icon.textContent = '○';
                }
            });

            return Object.values(requirements).every(req => req);
        }

        // フォーム検証
        function validateForm() {
            const code = document.getElementById('verificationCode');
            const password = document.getElementById('newPassword');
            const confirmPassword = document.getElementById('confirmPassword');
            const submitBtn = document.getElementById('submitBtn');

            let isValid = true;

            // 確認コードの検証（6桁の数字）
            const codeRegex = /^\d{6}$/;
            if (!codeRegex.test(code.value)) {
                if (code.value.length > 0) {
                    code.classList.add('error');
                    document.getElementById('codeError').style.display = 'block';
                }
                isValid = false;
            } else {
                code.classList.remove('error');
                code.classList.add('success');
                document.getElementById('codeError').style.display = 'none';
            }

            // パスワードの検証
            const passwordValid = checkPasswordRequirements(password.value);
            if (password.value.length > 0 && !passwordValid) {
                password.classList.add('error');
                document.getElementById('passwordError').style.display = 'block';
                isValid = false;
            } else if (passwordValid) {
                password.classList.remove('error');
                password.classList.add('success');
                document.getElementById('passwordError').style.display = 'none';
            }

            // パスワード確認の検証
            if (confirmPassword.value.length > 0) {
                if (password.value !== confirmPassword.value) {
                    confirmPassword.classList.add('error');
                    document.getElementById('confirmError').style.display = 'block';
                    document.getElementById('confirmSuccess').style.display = 'none';
                    isValid = false;
                } else {
                    confirmPassword.classList.remove('error');
                    confirmPassword.classList.add('success');
                    document.getElementById('confirmError').style.display = 'none';
                    document.getElementById('confirmSuccess').style.display = 'block';
                }
            }

            submitBtn.disabled = !isValid || !code.value || !password.value || !confirmPassword.value;
        }

        // 確認コード再送信
        document.getElementById('resendLink').addEventListener('click', (e) => {
            e.preventDefault();
            if (e.target.classList.contains('disabled')) return;

            alert('確認コードを再送信しました。\n新しいコードをご確認ください。');
            timeRemaining = 300; // タイマーリセット
            e.target.classList.add('disabled');
            startTimer();
        });

        // フォーム送信処理
        document.getElementById('passwordResetForm').addEventListener('submit', (e) => {
            e.preventDefault();

            if (!validateForm()) return;

            const submitBtn = document.getElementById('submitBtn');
            const originalText = submitBtn.innerHTML;

            // 送信中の表示
            submitBtn.innerHTML = '🔐 変更中...';
            submitBtn.disabled = true;

            // 送信処理のシミュレーション
            setTimeout(() => {
                alert('パスワードの変更が完了しました！\n\n新しいパスワードでログインしてください。\nセキュリティのため、すべてのデバイスからログアウトされました。');

                // 成功時はログイン画面へリダイレクト
                window.location.href = '../login.html';
            }, 2000);
        });

        // リアルタイム入力検証
        document.getElementById('verificationCode').addEventListener('input', (e) => {
            // 数字のみ入力可能
            e.target.value = e.target.value.replace(/[^\d]/g, '');
            validateForm();
        });

        document.getElementById('newPassword').addEventListener('input', validateForm);
        document.getElementById('confirmPassword').addEventListener('input', validateForm);

        // フォーカス時のエラー状態クリア
        document.querySelectorAll('.form-input').forEach(input => {
            input.addEventListener('focus', (e) => {
                e.target.classList.remove('error');
            });
        });

        // ページ読み込み時の初期化
        document.addEventListener('DOMContentLoaded', () => {
            startTimer();
            validateForm();

            // デモ用の確認コード自動入力（実際の実装では削除）
            // document.getElementById('verificationCode').value = '123456';
        });
    </script>
</body>
</html>
